# 04_アーキテクチャ＆開発運用
最終更新: 2025-08-31 (JST)

## 1. 技術選定（提案）
- **フロント**: React Native(Expo) / Web: Next.js(App Router) / TypeScript
- **状態**: Zustand + React Query（Query Persistence）
- **バックエンド**: NestJS + Prisma + PostgreSQL（Supabase推奨: Auth/DB/Storage/Edge Functions）
- **認証**: Supabase Auth（Email Link / OAuth）
- **検索API**: Google Books / Open Library（抽象`BookProvider`）
- **CI/CD**: GitHub Actions → EAS/Vercel/Supabase
- **計測**: PostHog or Amplitude

## 2. モノレポ構成
```
repo/
  apps/
    mobile/   # Expo
    web/      # Next.js
    api/      # NestJS
  packages/
    ui/       # 共通UI
    core/     # 型・SDK
    analytics/# 計測ラッパ
  infra/
    prisma/
    docker-compose.yml
  .github/workflows/
```

## 3. セキュリティ/権限
- RLS: `user_id = auth.uid()` 条件で `LibraryItem/ReadingSession/TocItem` を保護
- ストレージ: 署名付きURL、サムネ等は公開最小化
- 監査ログ: 作成/削除/エクスポート等の重要操作

## 4. オフライン/同期
- クライアント: React Query `persistQueryClient`（AsyncStorage）
- 再送: 読書セッション/ToC Upsertはキュー化→回線復帰時に送信
- 競合: `updatedAt`の楽観ロック、先勝ちルール

## 5. テスト/品質
- ユニット: ドメイン計算（進捗％等）
- API e2e: supertest（Nest）
- E2E: Playwright(Web)/Detox(RN)
- DoD: 主要フローe2eグリーン、型/ESLint/Prettierゼロ、計測イベント確認可能

## 6. イベント計測（例）
| event | props | 目的 |
|---|---|---|
| session_start | {libraryItemId} | 開始動線把握 |
| session_end | {libraryItemId, minutes, pages} | 成果測定 |
| book_add | {source} | 追加経路 |
| toc_save | {items, editedCount} | ToC利用状況 |

## 7. .env（例）
```env
NODE_ENV=development
NEXT_PUBLIC_API_URL=http://localhost:3000/api/v1
SUPABASE_URL=...
SUPABASE_ANON_KEY=...
DATABASE_URL=postgresql://...
JWT_SECRET=change_me
GOOGLE_BOOKS_API_KEY=optional
```

