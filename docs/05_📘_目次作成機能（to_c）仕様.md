# 05_📘目次作成機能（ToC）仕様
最終更新: 2025-08-31 (JST)

## 1. 概要
書誌APIから安定入手できない**目次**を、**OCR + 手動入力**で半自動生成。保存は**個人利用専用**（非共有）。画像は原則保存せず、テキストのみ保持。

## 2. 目的
- 構造化（章・節）によりコメント/評価/進捗を付けやすく
- ユーザー協力で生成し、法的/プライバシー配慮を両立

## 3. シナリオ
1) ISBNで書誌取得 → 2) 「目次を追加」 → 3) 入力方法（手動/OCR） → 4) 解析プレビュー → 5) 編集 → 6) 一括保存

## 4. 機能要件（P1/P2）
- **P1**: 手動入力→プレビュー→一括Upsert
- **P2**: 端末内OCR→テキスト化→自動パース（信頼度表示）
- 章単位のコメント/タグ/評価はP2以降

## 5. データ/API（抜粋）
- モデル: `TocItem { order, level, title, page?, source, confidence? }`
- API: `GET /library-items/:id/toc` / `POST .../toc/preview` / `POST .../toc` (Upsert) / `PATCH/DELETE /toc-items/:id`

## 6. UI
- Book Detailの**「目次」タブ**
- プレビューはツリー表示（order/level/title/page/confidence）
- 編集: 上下移動、インデント/アウトデント、タイトル/ページ編集、行追加/削除

## 7. パース仕様（方針）
- 番号書式・インデント量から `level` 推定、行末数値をページ候補
- 失敗行は `level=1` `confidence=0` として残し編集促進

## 8. 非機能
- 100行の目次でプレビュー<500ms、Upsertはトランザクション整合

## 9. 受け入れ基準
- プレビュー推定がサンプル基準で**概ね正確（80%目安）**
- 編集UIで5件以上の並べ替え/階層/編集が可能
- 保存後、進捗％に目次数が反映

## 10. タスク雛形（Claude Code）
- T-009: 解析ルール + テスト
- T-010: ToC API（プレビュー/Upsert/CRUD）
- T-011: ToC UI（編集UI）
- T-012: OCR入力（端末内）

